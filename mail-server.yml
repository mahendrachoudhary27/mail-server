---
 - name: creating playbook to configure mail-server
   hosts: localhost
   tasks:
     - name: install some packages
       apt:
         name:
           - postfix
           - dovecot-core
           - dovecot-imapd
           - dovecot-pop3d
           - opendkim
           - opendkim-tools
           - certbot
           - mailutils
           - dovecot-sieve
           - spamassassin
           - spamc

             #     - name: generating the ssl certificate for all 3 domains
             #       shell: certbot certonly --standalone -d mail.welovelucidgrowth.com -d mail.successlucidgrowth.com -d mail.techlucidgrowth.com --email mahendrajat5720@gmail.com --agree-tos

     - name: configuration in main.cf to configure postfix
       blockinfile:
         path: /etc/postfix/main.cf
         block: |
           mydomain = mail.welovelucidgrowth
           myorigin = $mydomain


     - name: mv the original file of dovecot.conf
       shell: cp -rv /etc/dovecot/dovecot.conf /home


     - name: create custome file of dovecot_custome.conf
       file:
         path: /etc/dovecot/dovecot_custome.conf
         state: touch

     - name: configuration for dovecot
       blockinfile:
         path: /etc/dovecot/dovecot_custome.conf
         block: |
           protocols = imap pop3
           mail_location = maildir:~/Maildir
           ssl = required
           ssl_cert = </etc/letsencrypt/live/mail.welovelucidgrowth.com/privkey.pem
           ssl_key = </etc/letsencrypt/live/mail.welovelucidgrowth.com/privkey.pem
           ssl_cert = </etc/letsencrypt/live/mail.successlucidgrowth.com/fullchain.pem
           ssl_key = </etc/letsencrypt/live/mail.successlucidgrowth.com/privkey.pem
           ssl_cert = </etc/letsencrypt/live/mail.techlucidgrowth.com/fullchain.pem
           ssl_key = </etc/letsencrypt/live/mail.techlucidgrowth.com/privkey.pem
           disable_plaintext_auth = yes
           service auth {
              unix_listener auth-userdb {
              user =  postfix
              group = postfix
           }

 - name: restart the dovecot and postfix service
       service:
         name: "{{ item }}"
         state: restarted
       loop:
         - postfix
         - dovecot

     - name: configuring opendkim entries
       blockinfile:
         path: /etc/opendkim.conf
         block: |
           logWhy             yes
           Syslog             yes
           KeyTable           refile:/etc/opendkim/key.table
           SigningTable       refile:/etc/opendkim/signing.table
           ExternalIgnoreList  /etc/opendkim/trusted.hosts
           InternalHosts       /etc/opendkim/trusted.hosts
           AutoRestart        yes
           AutoRestartRate     10/1M
           Background          yes
           DNSTimeout         5
           SignatureAlgorithm  rsa-sha256


     - name: create a opendkim direcotry
       file:
         path: /etc/opendkim
         state: directory

     - name: creating the files that we added in opendkim.conf
       file:
         path: /etc/opendkim/key.table
         state: touch

     - name: adding the entries of key.table
       blockinfile:
         path: /etc/opendkim/key.table
         block: |
           welovelucidgrowth.com     welovelucidgrowth.com:mail:/etc/opendkim/keys/welovelucidgrowth.com/mail.private
           successlucidgrowth.com    successlucidgrowth.com:mail:/etc/opendkim/keys/successlucidgrowth.com/mail.private
           techlucidgrowth.com       techlucidgrowth.com:mail:/etc/opendkim/keys/techlucidgrowth.com/mail.privat
     - name: creating signing table
       file:
         path: /etc/opendkim/signing.table
         state: touch


     - name: adding the entries of signing.table
       blockinfile:
         path: /etc/opendkim/signing.table
         block: |
           *@welovelucidgrowth.com        default._domainkey.welovelucidgrowth.com
           *@*.welovelucidgrowth.com      default._domainkey.welovelucidgrowth.com

           *@successlucidgrowth.com       default._domainkey.successlucidgrowth.com
           *@*.successlucidgrowth.com     default._domainkey.successlucidgrowth.com


           *@techlucidgrowth.com          default._domainkey.techlucidgrowth.com
           *@*.techlucidgrowth.com        default._domainkey.techlucidgrowth.com

     - name: creating trusted hosts file
       file:
         path: /etc/opendkim/trusted.hosts
         state: touch

     - name: adding some entries in /etc/trusted.hosts
       blockinfile:
         path: /etc/opendkim/trusted.hosts
         block: |
           127.0.0.1
           localhost
           .welovelucidgrowth.com

     - name: create some directories to save DKIM keys
       file:
         path: /etc/opendkim/keys/successlucidgrowth.com
         state: directory

     - name: creating key for welovelucidgrowth.com
       file:
         path: /etc/opendkim/keys/welovelucidgrowth.com
         state: directory
    - name: creating dkim key for techlucidgrowth.com
       file:
         path: /etc/opendkim/keys/techlucidgrowth.com
         state: directory

     - name: creating opendkim keys for welovelucidgrowth domain
       shell: opendkim-genkey -b 2048 -d welovelucidgrowth.com -D /etc/opendkim/keys/welovelucidgrowth.com -s default -v

     - name: creating opendkim key for successlucidgrowth.com domain
       shell: opendkim-genkey -b 2048 -d successlucidgrowth.com -D /etc/opendkim/keys/successlucidgrowth.com -s default -v

     - name: creating opendkim key for techlucidgrowth.com domain
       shell: opendkim-genkey -b 2048 -d techlucidgrowth.com -D /etc/opendkim/keys/techlucidgrowth.com -s default -v

     - name: changing ownership on default.private
       file:
         path: /etc/opendkim/keys/successlucidgrowth.com/default.private
         owner: opendkim
         group: opendkim
         mode: '600'

     - name: changing ownerhship on default.private of welovelucidgrowth.com
       file:
         path: /etc/opendkim/keys/welovelucidgrowth.com/default.private
         owner: opendkim
         group: opendkim
         mode: '600'

     - name: changing ownership and permission for techlucidgrowth.com on default.private
       file:
         path: /etc/opendkim/keys/techlucidgrowth.com/default.private
         owner: opendkim
         group: opendkim
         mode: '600'

     - name: create a directory in /var/spool/postfix/opendkim
       file:
         path: /var/spool/postfix/opendkim
         state: directory

     - name: changing ownership on /var/spool/postfix/opendkim
       file:
         path: /var/spool/postfix/opendkim
         owner: opendkim
         group: postfix

     - name: replace an entry in /etc/default/opendkim
       lineinfile:
         path: /etc/default/opendkim
         regexp: 'SOCKET=local:$RUNDIR/opendkim.sock'
         line: 'SOCKET="local:/var/spool/postfix/opendkim/opendkim.sock"'

     - name: add entries in /etc/postfix/main.cf
       blockinfile:
         path: /etc/postfix/main.cf
         block: |
           milter_default_action = accept
           milter_protocol = 6
           smtpd_milters = local:opendkim/opendkim.sock
           non_smtpd_milters = $smtpd_milters

     - name: replace a line in /etc/postfix/master.cf
       lineinfile:
         path: /etc/postfix/master.cf
         regexp: '^smtp      inet  n       -       y       -       -       smtpd'
         line: 'smtp      inet  n       -       -       -       -       smtpd -o content_filter=spamfilter'

     - name: add entries in /etc/postfix/master.cf
       lineinfile:
         path: /etc/postfix/master.cf
         line: |
           spamfilter
             unix  -       n       n       -       -       pipe
             flags=Rq user=spamd argv=/usr/bin/spamfilter.sh -oi -f ${sender} ${recipient}
         insertafter: 'smtp      inet  n       -       -       -       -       smtpd -o content_filter=spamfilter'
         state: present

     - name: restart the services
       service:
         name: "{{ item }}"
         state: restarted
         enabled: yes

       loop:
         - postfix
         - dovecot
         - opendkim
